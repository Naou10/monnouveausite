 {% comment %}
  Video Tabs (ronds) - UBELA
  Metafields attendus (namespace "custom") :
  - custom.custom_video_bienfaits
  - custom.custom_video_unboxing
  - custom.custom_video_preparation
  - custom.custom_video_recettes
  Posters (image) optionnels :
  - custom.custom_poster_bienfaits
  - custom.custom_poster_unboxing
  - custom.custom_poster_preparation
  - custom.custom_poster_recettes
{% endcomment %}

{%- liquid
  assign v1 = product.metafields.custom.custom_video_bienfaits
  assign v2 = product.metafields.custom.custom_video_unboxing
  assign v3 = product.metafields.custom.custom_video_preparation
  assign v4 = product.metafields.custom.custom_video_recettes

  assign p1 = product.metafields.custom.custom_poster_bienfaits
  assign p2 = product.metafields.custom.custom_poster_unboxing
  assign p3 = product.metafields.custom.custom_poster_preparation
  assign p4 = product.metafields.custom.custom_poster_recettes

  assign has_any = false
  if v1 != blank or v2 != blank or v3 != blank or v4 != blank
    assign has_any = true
  endif

  if has_any == false
    if request.design_mode
      echo '<div style="border:1px dashed #bbb;padding:12px;border-radius:10px;font-size:12px;">Ajoute au moins 1 vidéo dans les métachamps (custom_video_*) pour afficher les ronds.</div>'
    endif
    break
  endif

  assign uid = 'ube-video-tabs-' | append: section.id | append: '-' | append: block.id
-%}

<style>
  .ube-video-tabs { margin-top: 12px; }
  .ube-video-tabs__row { display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; }
  .ube-video-tabs__item { display:flex; flex-direction:column; align-items:center; gap:8px; }
  .ube-video-tabs__btn{
    width:78px; height:78px; border-radius:999px; padding:0;
    border:2px solid rgba(0,0,0,.15);
    background:transparent; cursor:pointer;
    overflow:hidden; position:relative;
  }
  .ube-video-tabs__btn:hover { border-color: rgba(0,0,0,.35); }
  .ube-video-tabs__btn:focus-visible { outline: 2px solid rgba(0,0,0,.65); outline-offset: 2px; }

  .ube-video-tabs__thumb {
    width:100%; height:100%; object-fit:cover; display:block;
  }
  .ube-video-tabs__thumb--placeholder{
    width:100%; height:100%;
    background: radial-gradient(circle at 30% 30%, rgba(0,0,0,.08), rgba(0,0,0,.03));
  }

  .ube-video-tabs__play{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;
  }
  .ube-video-tabs__play::before{
    content:"";
    width:24px; height:24px;
    background: rgba(0,0,0,.65);
    clip-path: polygon(35% 25%, 35% 75%, 80% 50%);
    border-radius: 3px;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
  }

  .ube-video-tabs__label{
    font-size:12px; line-height:1.2;
    text-align:center;
  }

  /* Modal */
  .ube-video-tabs__modal{
    position:fixed; inset:0;
    background: rgba(0,0,0,.65);
    display:flex; align-items:center; justify-content:center;
    padding:18px; z-index: 9999;
  }
  .ube-video-tabs__modal[hidden]{ display:none; }
  .ube-video-tabs__panel{
    width:min(920px, 100%);
    background:#000;
    border-radius:16px;
    overflow:hidden;
    position:relative;
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
  }
  .ube-video-tabs__close{
    position:absolute; top:10px; right:10px;
    width:38px; height:38px; border-radius:999px;
    border:0; cursor:pointer;
    background: rgba(255,255,255,.16);
    color:#fff; font-size:20px; line-height:38px;
  }
  .ube-video-tabs__player{
    width:100%; height:auto; display:block;
    background:#000;
  }

  /* ✅ Mobile : 4 ronds sur une seule ligne */
  @media (max-width: 749px){
    .ube-video-tabs__row{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
      justify-items:center;
    }
    .ube-video-tabs__btn{ width:62px; height:62px; }
    .ube-video-tabs__label{ font-size:11px; }
  }

  @media (max-width: 360px){
    .ube-video-tabs__btn{ width:56px; height:56px; }
  }
</style>

<div class="ube-video-tabs" id="{{ uid }}">
  <div class="ube-video-tabs__row" aria-label="Vidéos">

    {%- comment -%} 1) Bienfaits {%- endcomment -%}
    {%- if v1 != blank -%}
      {%- liquid
        assign src1 = v1.value | file_url
        assign thumb1 = blank
        if p1 != blank and p1.value != blank
          assign thumb1 = p1.value | image_url: width: 300
        elsif v1.value.preview_image != blank
          assign thumb1 = v1.value.preview_image | image_url: width: 300
        endif
      -%}
      <div class="ube-video-tabs__item">
        <button class="ube-video-tabs__btn" type="button" data-src="{{ src1 }}" aria-label="Vidéo Bienfaits">
          {%- if thumb1 != blank -%}
            <img class="ube-video-tabs__thumb" src="{{ thumb1 }}" alt="">
          {%- else -%}
            <div class="ube-video-tabs__thumb--placeholder" aria-hidden="true"></div>
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true"></span>
        </button>
        <div class="ube-video-tabs__label">Bienfaits</div>
      </div>
    {%- endif -%}

    {%- comment -%} 2) Unboxing {%- endcomment -%}
    {%- if v2 != blank -%}
      {%- liquid
        assign src2 = v2.value | file_url
        assign thumb2 = blank
        if p2 != blank and p2.value != blank
          assign thumb2 = p2.value | image_url: width: 300
        elsif v2.value.preview_image != blank
          assign thumb2 = v2.value.preview_image | image_url: width: 300
        endif
      -%}
      <div class="ube-video-tabs__item">
        <button class="ube-video-tabs__btn" type="button" data-src="{{ src2 }}" aria-label="Vidéo Unboxing">
          {%- if thumb2 != blank -%}
            <img class="ube-video-tabs__thumb" src="{{ thumb2 }}" alt="">
          {%- else -%}
            <div class="ube-video-tabs__thumb--placeholder" aria-hidden="true"></div>
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true"></span>
        </button>
        <div class="ube-video-tabs__label">Unboxing</div>
      </div>
    {%- endif -%}

    {%- comment -%} 3) Préparation {%- endcomment -%}
    {%- if v3 != blank -%}
      {%- liquid
        assign src3 = v3.value | file_url
        assign thumb3 = blank
        if p3 != blank and p3.value != blank
          assign thumb3 = p3.value | image_url: width: 300
        elsif v3.value.preview_image != blank
          assign thumb3 = v3.value.preview_image | image_url: width: 300
        endif
      -%}
      <div class="ube-video-tabs__item">
        <button class="ube-video-tabs__btn" type="button" data-src="{{ src3 }}" aria-label="Vidéo Préparation">
          {%- if thumb3 != blank -%}
            <img class="ube-video-tabs__thumb" src="{{ thumb3 }}" alt="">
          {%- else -%}
            <div class="ube-video-tabs__thumb--placeholder" aria-hidden="true"></div>
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true"></span>
        </button>
        <div class="ube-video-tabs__label">Préparation</div>
      </div>
    {%- endif -%}

    {%- comment -%} 4) Recettes {%- endcomment -%}
    {%- if v4 != blank -%}
      {%- liquid
        assign src4 = v4.value | file_url
        assign thumb4 = blank
        if p4 != blank and p4.value != blank
          assign thumb4 = p4.value | image_url: width: 300
        elsif v4.value.preview_image != blank
          assign thumb4 = v4.value.preview_image | image_url: width: 300
        endif
      -%}
      <div class="ube-video-tabs__item">
        <button class="ube-video-tabs__btn" type="button" data-src="{{ src4 }}" aria-label="Vidéo Recettes">
          {%- if thumb4 != blank -%}
            <img class="ube-video-tabs__thumb" src="{{ thumb4 }}" alt="">
          {%- else -%}
            <div class="ube-video-tabs__thumb--placeholder" aria-hidden="true"></div>
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true"></span>
        </button>
        <div class="ube-video-tabs__label">Recettes</div>
      </div>
    {%- endif -%}

  </div>

  <div class="ube-video-tabs__modal" hidden>
    <div class="ube-video-tabs__panel" role="dialog" aria-modal="true" aria-label="Lecture vidéo">
      <button class="ube-video-tabs__close" type="button" aria-label="Fermer">×</button>
      <video class="ube-video-tabs__player" controls playsinline preload="metadata"></video>
    </div>
  </div>
</div>

<script>
(function () {
  var root = document.getElementById({{ uid | json }});
  if (!root) return;

  var modal = root.querySelector('.ube-video-tabs__modal');
  var player = root.querySelector('.ube-video-tabs__player');
  var closeBtn = root.querySelector('.ube-video-tabs__close');
  var buttons = root.querySelectorAll('.ube-video-tabs__btn');

  function openWith(src) {
    if (!src) return;
    modal.hidden = false;

    // reset propre
    player.pause();
    player.removeAttribute('src');
    player.load();

    player.src = src;
    player.load();

    // Essaye de lancer (sur clic utilisateur ça passe)
    var p = player.play();
    if (p && typeof p.catch === 'function') p.catch(function(){});
  }

  function close() {
    modal.hidden = true;
    player.pause();
    player.removeAttribute('src');
    player.load();
  }

  buttons.forEach(function(btn){
    btn.addEventListener('click', function(){
      openWith(btn.getAttribute('data-src'));
    });
  });

  closeBtn.addEventListener('click', close);
  modal.addEventListener('click', function(e){
    if (e.target === modal) close();
  });

  document.addEventListener('keydown', function(e){
    if (!modal.hidden && e.key === 'Escape') close();
  });
})();
</script>
