 {%- liquid
  assign v1 = product.metafields.custom.custom_video_bienfaits
  assign v2 = product.metafields.custom.custom_video_unboxing
  assign v3 = product.metafields.custom.custom_video_preparation
  assign v4 = product.metafields.custom.custom_video_recettes

  assign has_any = false
  if v1 != blank or v2 != blank or v3 != blank or v4 != blank
    assign has_any = true
  endif
-%}
{%- if has_any == false -%}
  {%- if request.design_mode -%}
    <div style="border:1px dashed #bbb;padding:12px;border-radius:10px;font-size:12px;">
      Ajoute au moins 1 vidéo dans les métachamps pour afficher les ronds.
    </div>
  {%- endif -%}
{%- else -%}
{%- assign uid = 'ube-video-tabs-' | append: section.id | append: '-' | append: block.id -%}
<style>
  .ube-video-tabs { margin-top: 12px; }
  .ube-video-tabs__row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .ube-video-tabs__btn {
    width:78px; height:78px; border-radius:999px; padding:0;
    border:2px solid rgba(0,0,0,.15); background:transparent; cursor:pointer;
    overflow:hidden; position:relative;
  }
  .ube-video-tabs__btn.is-active { border-color: rgba(0,0,0,.55); }
  .ube-video-tabs__thumb {
    width:100%; height:100%; object-fit:cover; display:block;
  }

  /* Modal */
  .ube-video-tabs__modal {
    position: fixed; inset: 0; background: rgba(0,0,0,.65);
    display:flex; align-items:center; justify-content:center;
    padding: 18px; z-index: 9999;
  }
  .ube-video-tabs__modal[hidden] { display:none; }
  .ube-video-tabs__panel {
    width:min(920px, 100%); background:#000; border-radius:16px; overflow:hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,.35); position:relative;
  }
  .ube-video-tabs__close {
    position:absolute; top:10px; right:10px;
    width:38px; height:38px; border-radius:999px;
    border:0; background:rgba(255,255,255,.12); color:#fff; cursor:pointer;
    font-size:20px; line-height:38px;
  }
  .ube-video-tabs__player { width:100%; height:auto; display:block; background:#000; }
</style>
<div class="ube-video-tabs" id="{{ uid }}">
  <div class="ube-video-tabs__row" aria-label="Vidéos">
    {%- if v1 != blank -%}
      <button class="ube-video-tabs__btn" type="button"
              data-src="{{ v1.value | file_url }}" aria-label="Vidéo bienfaits">
        <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata">
          <source src="{{ v1.value | file_url }}" type="video/mp4">
        </video>
      </button>
    {%- endif -%}
    {%- if v2 != blank -%}
      <button class="ube-video-tabs__btn" type="button"
              data-src="{{ v2.value | file_url }}" aria-label="Vidéo unboxing">
        <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata">
          <source src="{{ v2.value | file_url }}" type="video/mp4">
        </video>
      </button>
    {%- endif -%}
    {%- if v3 != blank -%}
      <button class="ube-video-tabs__btn" type="button"
              data-src="{{ v3.value | file_url }}" aria-label="Vidéo préparation">
        <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata">
          <source src="{{ v3.value | file_url }}" type="video/mp4">
        </video>
      </button>
    {%- endif -%}
    {%- if v4 != blank -%}
      <button class="ube-video-tabs__btn" type="button"
              data-src="{{ v4.value | file_url }}" aria-label="Vidéo recettes">
        <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata">
          <source src="{{ v4.value | file_url }}" type="video/mp4">
        </video>
      </button>
    {%- endif -%}
  </div>
  <div class="ube-video-tabs__modal" hidden>
    <div class="ube-video-tabs__panel" role="dialog" aria-modal="true">
      <button class="ube-video-tabs__close" type="button" aria-label="Fermer">×</button>
      <video class="ube-video-tabs__player" controls playsinline></video>
    </div>
  </div>
</div>
<script>
  (function () {
    var root = document.getElementById({{ uid | json }});
    if (!root) return;
    var buttons = root.querySelectorAll('.ube-video-tabs__btn');
    var thumbs  = root.querySelectorAll('.ube-video-tabs__thumb');
    var modal   = root.querySelector('.ube-video-tabs__modal');
    var panel   = root.querySelector('.ube-video-tabs__panel');
    var closeBtn= root.querySelector('.ube-video-tabs__close');
    var player  = root.querySelector('.ube-video-tabs__player');
    // Autoplay thumbs (muted)
    thumbs.forEach(function(v){ try { v.play(); } catch(e){} });

    function openWith(src, clickedBtn){
      buttons.forEach(function(b){ b.classList.remove('is-active'); });
      if (clickedBtn) clickedBtn.classList.add('is-active');
      player.pause();
      player.removeAttribute('src');
      player.load();
      player.src = src;
      modal.hidden = false;
      try { player.play(); } catch(e){}
    }
    function close(){
      modal.hidden = true;
      player.pause();
      player.removeAttribute('src');
      player.load();
      buttons.forEach(function(b){ b.classList.remove('is-active'); });
    }
    buttons.forEach(function(btn){
      btn.addEventListener('click', function(){
        var src = btn.getAttribute('data-src');
        if (src) openWith(src, btn);
      });
    });
    closeBtn.addEventListener('click', close);
    modal.addEventListener('click', function(e){
      if (e.target === modal) close();
    });
    document.addEventListener('keydown', function(e){
      if (!modal.hidden && e.key === 'Escape') close();
    });
  })();
</script>
{%- endif -%}
