 {%- comment -%}
  UBELA — Video Tabs (ronds)
  Metafields utilisés (namespace "custom") :
  - custom_video_bienfaits / unboxing / preparation / recettes   (Vidéo - Fichier)
  - custom_poster_bienfaits / unboxing / preparation / recettes (Optionnel) (Image ou Vidéo - Fichier)
{%- endcomment -%}

{%- liquid
  assign v1 = product.metafields.custom.custom_video
  assign v2 = product.metafields.custom.custom_video
  assign v3 = product.metafields.custom.custom_video
  assign v4 = product.metafields.custom.custom_video

  assign p1 = product.metafields.custom.custom_poster
  assign p2 = product.metafields.custom.custom_poster
  assign p3 = product.metafields.custom.custom_poster
  assign p4 = product.metafields.custom.custom_poster

  assign v1m = v1.value
  assign v2m = v2.value
  assign v3m = v3.value
  assign v4m = v4.value

  assign p1m = p1.value
  assign p2m = p2.value
  assign p3m = p3.value
  assign p4m = p4.value

  assign has_any = false
  if v1m != blank or v2m != blank or v3m != blank or v4m != blank
    assign has_any = true
  endif
-%}

{%- if has_any == false -%}
  {%- if request.design_mode -%}
    <div style="border:1px dashed #bbb;padding:12px;border-radius:10px;font-size:12px;">
      Ajoute au moins 1 vidéo dans les métachamps (custom_video_*) pour afficher les ronds.
    </div>
  {%- endif -%}
{%- else -%}

  {%- liquid
    assign v1_url = v1m | file_url
    if v1m != blank and v1m.sources != blank
      for s in v1m.sources
        if s.mime_type == 'video/mp4'
          assign v1_url = s.url
          break
        endif
      endfor
    endif

    assign v2_url = v2m | file_url
    if v2m != blank and v2m.sources != blank
      for s in v2m.sources
        if s.mime_type == 'video/mp4'
          assign v2_url = s.url
          break
        endif
      endfor
    endif

    assign v3_url = v3m | file_url
    if v3m != blank and v3m.sources != blank
      for s in v3m.sources
        if s.mime_type == 'video/mp4'
          assign v3_url = s.url
          break
        endif
      endfor
    endif

    assign v4_url = v4m | file_url
    if v4m != blank and v4m.sources != blank
      for s in v4m.sources
        if s.mime_type == 'video/mp4'
          assign v4_url = s.url
          break
        endif
      endfor
    endif

    assign t1 = blank
    if v1m != blank and v1m.preview_image != blank
      assign t1 = v1m.preview_image | image_url: width: 300
    elsif p1m != blank and p1m.preview_image != blank
      assign t1 = p1m.preview_image | image_url: width: 300
    endif

    assign t2 = blank
    if v2m != blank and v2m.preview_image != blank
      assign t2 = v2m.preview_image | image_url: width: 300
    elsif p2m != blank and p2m.preview_image != blank
      assign t2 = p2m.preview_image | image_url: width: 300
    endif

    assign t3 = blank
    if v3m != blank and v3m.preview_image != blank
      assign t3 = v3m.preview_image | image_url: width: 300
    elsif p3m != blank and p3m.preview_image != blank
      assign t3 = p3m.preview_image | image_url: width: 300
    endif

    assign t4 = blank
    if v4m != blank and v4m.preview_image != blank
      assign t4 = v4m.preview_image | image_url: width: 300
    elsif p4m != blank and p4m.preview_image != blank
      assign t4 = p4m.preview_image | image_url: width: 300
    endif

    assign uid = 'ube-video-tabs-' | append: section.id | append: '-' | append: block.id
  -%}

  <style>
    .ube-video-tabs{ margin-top:12px; }
    .ube-video-tabs__row{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .ube-video-tabs__item{ display:flex; flex-direction:column; align-items:center; gap:8px; }
    .ube-video-tabs__btn{
      width:78px; height:78px; border-radius:999px; padding:0;
      border:2px solid rgba(0,0,0,.15); background:transparent; cursor:pointer;
      overflow:hidden; position:relative;
    }
    .ube-video-tabs__btn.is-active{ border-color: rgba(0,0,0,.55); }
    .ube-video-tabs__thumb{ width:100%; height:100%; object-fit:cover; display:block; background:#eee; }
    .ube-video-tabs__play{
      position:absolute; inset:auto 8px 8px auto;
      width:22px; height:22px; border-radius:999px;
      background:rgba(0,0,0,.55); color:#fff; font-size:12px;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
    }
    .ube-video-tabs__label{ font-size:12px; line-height:1.1; text-align:center; opacity:.9; }

    .ube-video-tabs__modal{ position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:9999;
      display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .ube-video-tabs__modal[hidden]{ display:none; }
    .ube-video-tabs__panel{
      width:min(920px, 100%); background:#000; border-radius:16px; overflow:hidden; position:relative;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .ube-video-tabs__close{
      position:absolute; top:10px; right:10px;
      width:38px; height:38px; border-radius:999px;
      border:0; background:rgba(255,255,255,.12); color:#fff;
      font-size:22px; line-height:38px; cursor:pointer;
      z-index:2;
    }
    .ube-video-tabs__player{ width:100%; height:auto; display:block; background:#000; }
  </style>

  <div class="ube-video-tabs" id="{{ uid }}">
    <div class="ube-video-tabs__row" aria-label="Vidéos">
      {%- if v1m != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button" data-src="{{ v1_url | escape }}" aria-label="Vidéo bienfaits">
            <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata"
              {%- if t1 != blank -%} poster="{{ t1 | escape }}"{%- endif -%}>
              <source src="{{ v1_url | escape }}" type="video/mp4">
            </video>
            <span class="ube-video-tabs__play" aria-hidden="true">▶</span>
          </button>
          <div class="ube-video-tabs__label">Bienfaits</div>
        </div>
      {%- endif -%}

      {%- if v2m != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button" data-src="{{ v2_url | escape }}" aria-label="Vidéo unboxing">
            <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata"
              {%- if t2 != blank -%} poster="{{ t2 | escape }}"{%- endif -%}>
              <source src="{{ v2_url | escape }}" type="video/mp4">
            </video>
            <span class="ube-video-tabs__play" aria-hidden="true">▶</span>
          </button>
          <div class="ube-video-tabs__label">Unboxing</div>
        </div>
      {%- endif -%}

      {%- if v3m != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button" data-src="{{ v3_url | escape }}" aria-label="Vidéo préparation">
            <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata"
              {%- if t3 != blank -%} poster="{{ t3 | escape }}"{%- endif -%}>
              <source src="{{ v3_url | escape }}" type="video/mp4">
            </video>
            <span class="ube-video-tabs__play" aria-hidden="true">▶</span>
          </button>
          <div class="ube-video-tabs__label">Préparation</div>
        </div>
      {%- endif -%}

      {%- if v4m != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button" data-src="{{ v4_url | escape }}" aria-label="Vidéo recettes">
            <video class="ube-video-tabs__thumb" muted playsinline loop preload="metadata"
              {%- if t4 != blank -%} poster="{{ t4 | escape }}"{%- endif -%}>
              <source src="{{ v4_url | escape }}" type="video/mp4">
            </video>
            <span class="ube-video-tabs__play" aria-hidden="true">▶</span>
          </button>
          <div class="ube-video-tabs__label">Recettes</div>
        </div>
      {%- endif -%}
    </div>

    <div class="ube-video-tabs__modal" hidden>
      <div class="ube-video-tabs__panel" role="dialog" aria-modal="true" aria-label="Vidéo">
        <button class="ube-video-tabs__close" type="button" aria-label="Fermer">×</button>
        <video class="ube-video-tabs__player" controls playsinline></video>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var root = document.getElementById({{ uid | json }});
      if (!root || root.dataset.ubeBound === "1") return;
      root.dataset.ubeBound = "1";

      var modal = root.querySelector(".ube-video-tabs__modal");
      var panel = root.querySelector(".ube-video-tabs__panel");
      var closeBtn = root.querySelector(".ube-video-tabs__close");
      var player = root.querySelector(".ube-video-tabs__player");
      var buttons = root.querySelectorAll(".ube-video-tabs__btn");

      function openWith(src, clickedBtn) {
        if (!src) return;

        buttons.forEach(function (b) { b.classList.remove("is-active"); });
        if (clickedBtn) clickedBtn.classList.add("is-active");

        modal.hidden = false;

        // Reset + set src
        try { player.pause(); } catch(e) {}
        player.removeAttribute("src");
        player.load();
        player.src = src;

        // Essaye de jouer (certains navigateurs demandent muted)
        (async function () {
          try {
            player.muted = false;
            await player.play();
          } catch (e1) {
            try {
              player.muted = true;
              await player.play();
            } catch (e2) {}
          }
        })();
      }

      function close() {
        modal.hidden = true;
        try { player.pause(); } catch(e) {}
        player.removeAttribute("src");
        player.load();
        buttons.forEach(function (b) { b.classList.remove("is-active"); });
      }

      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var src = btn.getAttribute("data-src");
          openWith(src, btn);
        });
      });

      closeBtn.addEventListener("click", close);

      modal.addEventListener("click", function (e) {
        if (e.target === modal) close();
      });

      panel.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      document.addEventListener("keydown", function (e) {
        if (!modal.hidden && e.key === "Escape") close();
      });
    })();
  </script>

{%- endif -%}