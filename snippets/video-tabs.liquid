{%- comment -%}
  Video Tabs (ronds)
  Metafields utilisés (namespace: custom) :
  - custom.custom_video_bienfaits
  - custom.custom_video_unboxing
  - custom.custom_video_preparation
  - custom.custom_video_recettes
  - custom.custom_poster_bienfaits
  - custom.custom_poster_unboxing
  - custom.custom_poster_preparation
  - custom.custom_poster_recettes

  Ce snippet doit être rendu avec :
  {% render 'video-tabs', product: product, block: block, section: section %}
{%- endcomment -%}

{%- liquid
  assign p = product
  if p == blank and section.settings.product != blank
    assign p = section.settings.product
  endif

  assign block_id = block.id | default: 'x'
  assign uid = 'ube-video-tabs-' | append: section.id | append: '-' | append: block_id

  assign v1_mf = p.metafields.custom.custom_video_bienfaits
  assign v2_mf = p.metafields.custom.custom_video_unboxing
  assign v3_mf = p.metafields.custom.custom_video_preparation
  assign v4_mf = p.metafields.custom.custom_video_recettes

  assign v1_url = v1_mf.value | file_url
  assign v2_url = v2_mf.value | file_url
  assign v3_url = v3_mf.value | file_url
  assign v4_url = v4_mf.value | file_url

  assign p1_mf = p.metafields.custom.custom_poster_bienfaits
  assign p2_mf = p.metafields.custom.custom_poster_unboxing
  assign p3_mf = p.metafields.custom.custom_poster_preparation
  assign p4_mf = p.metafields.custom.custom_poster_recettes

  assign p1_url = p1_mf.value | image_url: width: 240
  assign p2_url = p2_mf.value | image_url: width: 240
  assign p3_url = p3_mf.value | image_url: width: 240
  assign p4_url = p4_mf.value | image_url: width: 240

  assign has_any = false
  if v1_url != blank or v2_url != blank or v3_url != blank or v4_url != blank
    assign has_any = true
  endif
-%}

{%- if has_any == false -%}
  {%- if request.design_mode -%}
    <div style="border:1px dashed #bbb; padding:12px; border-radius:10px; font-size:12px;">
      Ajoute au moins 1 vidéo dans les métachamps (custom_video_*) pour afficher les ronds.
    </div>
  {%- endif -%}
{%- else -%}

<style>
  .ube-video-tabs{ margin-top:12px; }
  .ube-video-tabs__grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(0, 1fr)); /* 4 ronds côte à côte sur mobile */
    gap:10px;
    align-items:start;
  }
  .ube-video-tabs__item{
    border:0; background:transparent; padding:0; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .ube-video-tabs__circle{
    width:64px; height:64px; border-radius:999px;
    border:2px solid rgba(0,0,0,.15);
    overflow:hidden; position:relative;
    background:#f3f3f3;
  }
  .ube-video-tabs__circle img{
    width:100%; height:100%; display:block; object-fit:cover;
  }
  .ube-video-tabs__play{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;
  }
  .ube-video-tabs__play svg{
    width:18px; height:18px;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
  }
  .ube-video-tabs__label{
    font-size:12px; line-height:1.1; text-align:center;
  }

  /* Un peu plus grand sur desktop */
  @media (min-width: 750px){
    .ube-video-tabs__circle{ width:72px; height:72px; }
    .ube-video-tabs__grid{ gap:14px; }
  }

  /* Modal */
  .ube-video-tabs__modal{
    position:fixed; inset:0; background:rgba(0,0,0,.65);
    display:flex; align-items:center; justify-content:center;
    padding:18px; z-index:9999;
  }
  .ube-video-tabs__modal[hidden]{ display:none; }
  .ube-video-tabs__panel{
    width:min(920px, 100%);
    background:#000; border-radius:16px; overflow:hidden;
    position:relative;
  }
  .ube-video-tabs__close{
    position:absolute; top:10px; right:10px;
    width:38px; height:38px; border-radius:999px;
    border:0; background:rgba(255,255,255,.12); color:#fff;
    cursor:pointer; font-size:22px; line-height:38px;
  }
  .ube-video-tabs__player{
    width:100%; height:auto; display:block; background:#000;
  }
</style>

<div class="ube-video-tabs" id="{{ uid }}">
  <div class="ube-video-tabs__grid" aria-label="Vidéos">
    {%- if v1_url != blank -%}
      <button class="ube-video-tabs__item" type="button" data-src="{{ v1_url | escape }}" aria-label="Lire vidéo Bienfaits">
        <span class="ube-video-tabs__circle">
          {%- if p1_url != blank -%}
            <img src="{{ p1_url }}" alt="" loading="lazy">
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M10 8.5V15.5L16 12L10 8.5Z" fill="white"/>
              <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" opacity=".85"/>
            </svg>
          </span>
        </span>
        <span class="ube-video-tabs__label">Bienfaits</span>
      </button>
    {%- endif -%}

    {%- if v2_url != blank -%}
      <button class="ube-video-tabs__item" type="button" data-src="{{ v2_url | escape }}" aria-label="Lire vidéo Unboxing">
        <span class="ube-video-tabs__circle">
          {%- if p2_url != blank -%}
            <img src="{{ p2_url }}" alt="" loading="lazy">
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M10 8.5V15.5L16 12L10 8.5Z" fill="white"/>
              <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" opacity=".85"/>
            </svg>
          </span>
        </span>
        <span class="ube-video-tabs__label">Unboxing</span>
      </button>
    {%- endif -%}

    {%- if v3_url != blank -%}
      <button class="ube-video-tabs__item" type="button" data-src="{{ v3_url | escape }}" aria-label="Lire vidéo Préparation">
        <span class="ube-video-tabs__circle">
          {%- if p3_url != blank -%}
            <img src="{{ p3_url }}" alt="" loading="lazy">
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M10 8.5V15.5L16 12L10 8.5Z" fill="white"/>
              <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" opacity=".85"/>
            </svg>
          </span>
        </span>
        <span class="ube-video-tabs__label">Préparation</span>
      </button>
    {%- endif -%}

    {%- if v4_url != blank -%}
      <button class="ube-video-tabs__item" type="button" data-src="{{ v4_url | escape }}" aria-label="Lire vidéo Recettes">
        <span class="ube-video-tabs__circle">
          {%- if p4_url != blank -%}
            <img src="{{ p4_url }}" alt="" loading="lazy">
          {%- endif -%}
          <span class="ube-video-tabs__play" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M10 8.5V15.5L16 12L10 8.5Z" fill="white"/>
              <circle cx="12" cy="12" r="10" stroke="white" stroke-width="1.5" opacity=".85"/>
            </svg>
          </span>
        </span>
        <span class="ube-video-tabs__label">Recettes</span>
      </button>
    {%- endif -%}
  </div>

  <div class="ube-video-tabs__modal" hidden>
    <div class="ube-video-tabs__panel" role="dialog" aria-modal="true">
      <button class="ube-video-tabs__close" type="button" aria-label="Fermer">×</button>
      <video class="ube-video-tabs__player" controls playsinline></video>
    </div>
  </div>
</div>

<script>
(function () {
  var root = document.getElementById({{ uid | json }});
  if (!root) return;

  var modal = root.querySelector('.ube-video-tabs__modal');
  var player = root.querySelector('.ube-video-tabs__player');
  var closeBtn = root.querySelector('.ube-video-tabs__close');
  var buttons = root.querySelectorAll('.ube-video-tabs__item');

  function normalizeUrl(src){
    if (!src) return src;
    if (src.indexOf('//') === 0) src = window.location.protocol + src;
    return src;
  }

  function setVideoSource(src){
    // enlève les <source> existantes
    while (player.firstChild) player.removeChild(player.firstChild);

    var s = document.createElement('source');
    s.src = src;
    player.appendChild(s);
  }

  function tryPlay(){
    var p = player.play();
    if (p && typeof p.catch === 'function') p.catch(function(){});
  }

  function openWith(src){
    src = normalizeUrl(src);
    if (!src) return;

    modal.hidden = false;

    // reset propre
    player.pause();
    player.removeAttribute('src');
    while (player.firstChild) player.removeChild(player.firstChild);
    player.load();

    // iOS/Safari
    player.setAttribute('playsinline', '');
    player.setAttribute('webkit-playsinline', '');

    setVideoSource(src);
    player.load();

    var onMeta = function () {
      player.removeEventListener('loadedmetadata', onMeta);
      tryPlay();
    };
    player.addEventListener('loadedmetadata', onMeta);

    setTimeout(tryPlay, 250);
  }

  function close(){
    modal.hidden = true;
    player.pause();
    player.removeAttribute('src');
    while (player.firstChild) player.removeChild(player.firstChild);
    player.load();
  }

  buttons.forEach(function(btn){
    btn.addEventListener('click', function(){
      openWith(btn.getAttribute('data-src'));
    });
  });

  closeBtn.addEventListener('click', close);
  modal.addEventListener('click', function(e){
    if (e.target === modal) close();
  });

  document.addEventListener('keydown', function(e){
    if (!modal.hidden && e.key === 'Escape') close();
  });
})();
</script>

{%- endif -%}