 {%- liquid
  assign v1 = product.metafields.custom.custom_video_bienfaits
  assign v2 = product.metafields.custom.custom_video_unboxing
  assign v3 = product.metafields.custom.custom_video_preparation
  assign v4 = product.metafields.custom.custom_video_recettes

  assign has_any = false
  if v1 != blank or v2 != blank or v3 != blank or v4 != blank
    assign has_any = true
  endif

  assign _section_id = section.id | default: 'section'
  assign _block_id = block.id | default: 'block'
  assign uid = 'ube-video-tabs-' | append: _section_id | append: '-' | append: _block_id
-%}

{%- if has_any -%}
  <style>
    .ube-video-tabs { margin-top: 12px; }
    .ube-video-tabs__row { display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; }
    .ube-video-tabs__item { display:flex; flex-direction:column; align-items:center; gap:6px; width:84px; }
    .ube-video-tabs__btn{
      width:78px; height:78px; border-radius:999px; padding:0;
      border:2px solid rgba(0,0,0,.15); background:transparent; cursor:pointer;
      overflow:hidden; position:relative;
    }
    .ube-video-tabs__btn:hover{ border-color: rgba(0,0,0,.35); }
    .ube-video-tabs__thumb{
      width:100%; height:100%; object-fit:cover; display:block;
      background:#f2f2f2;
    }
    .ube-video-tabs__btn:after{
      content:"▶";
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; color:#fff;
      text-shadow:0 2px 10px rgba(0,0,0,.45);
      opacity:.95;
      pointer-events:none;
    }
    .ube-video-tabs__label{ font-size:12px; line-height:1.2; text-align:center; opacity:.9; }

    .ube-video-tabs__modal{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center;
      padding:18px; z-index:9999;
    }
    .ube-video-tabs__modal[hidden]{ display:none; }
    .ube-video-tabs__panel{
      width:min(920px, 100%);
      background:#000; border-radius:16px; overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      position:relative;
    }
    .ube-video-tabs__close{
      position:absolute; top:10px; right:10px;
      width:38px; height:38px; border-radius:999px;
      border:0; background:rgba(255,255,255,.12);
      color:#fff; cursor:pointer; font-size:20px; line-height:38px;
      z-index:2;
    }
    .ube-video-tabs__player{ width:100%; height:auto; display:block; background:#000; }
  </style>

  <div class="ube-video-tabs" id="{{ uid }}">
    <div class="ube-video-tabs__row" aria-label="Vidéos">
      {%- if v1 != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button"
            data-src="{{ v1.value | file_url }}" aria-label="Vidéo bienfaits">
            <img class="ube-video-tabs__thumb"
              src="{{ v1.value.preview_image | image_url: width: 240 }}"
              alt="Bienfaits" loading="lazy">
          </button>
          <div class="ube-video-tabs__label">Bienfaits</div>
        </div>
      {%- endif -%}

      {%- if v2 != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button"
            data-src="{{ v2.value | file_url }}" aria-label="Vidéo unboxing">
            <img class="ube-video-tabs__thumb"
              src="{{ v2.value.preview_image | image_url: width: 240 }}"
              alt="Unboxing" loading="lazy">
          </button>
          <div class="ube-video-tabs__label">Unboxing</div>
        </div>
      {%- endif -%}

      {%- if v3 != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button"
            data-src="{{ v3.value | file_url }}" aria-label="Vidéo préparation">
            <img class="ube-video-tabs__thumb"
              src="{{ v3.value.preview_image | image_url: width: 240 }}"
              alt="Préparation" loading="lazy">
          </button>
          <div class="ube-video-tabs__label">Préparation</div>
        </div>
      {%- endif -%}

      {%- if v4 != blank -%}
        <div class="ube-video-tabs__item">
          <button class="ube-video-tabs__btn" type="button"
            data-src="{{ v4.value | file_url }}" aria-label="Vidéo recettes">
            <img class="ube-video-tabs__thumb"
              src="{{ v4.value.preview_image | image_url: width: 240 }}"
              alt="Recettes" loading="lazy">
          </button>
          <div class="ube-video-tabs__label">Recettes</div>
        </div>
      {%- endif -%}
    </div>

    <div class="ube-video-tabs__modal" hidden>
      <div class="ube-video-tabs__panel" role="dialog" aria-modal="true">
        <button class="ube-video-tabs__close" type="button" aria-label="Fermer">×</button>
        <video class="ube-video-tabs__player" controls playsinline></video>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var root = document.getElementById({{ uid | json }});
      if (!root) return;

      var modal = root.querySelector('.ube-video-tabs__modal');
      var panel = root.querySelector('.ube-video-tabs__panel');
      var closeBtn = root.querySelector('.ube-video-tabs__close');
      var player = root.querySelector('.ube-video-tabs__player');
      var buttons = root.querySelectorAll('.ube-video-tabs__btn');

      function openWith(src) {
        if (!src) return;
        player.pause();
        player.removeAttribute('src');
        player.load();
        player.src = src;
        modal.hidden = false;
        try { player.play(); } catch(e) {}
      }

      function close() {
        modal.hidden = true;
        player.pause();
        player.removeAttribute('src');
        player.load();
      }

      buttons.forEach(function(btn){
        btn.addEventListener('click', function(){
          openWith(btn.getAttribute('data-src'));
        });
      });

      closeBtn.addEventListener('click', close);
      modal.addEventListener('click', function(e){
        if (e.target === modal) close();
      });
      document.addEventListener('keydown', function(e){
        if (!modal.hidden && e.key === 'Escape') close();
      });
    })();
  </script>

{%- elsif request.design_mode -%}
  <div style="border:1px dashed #bbb;padding:12px;border-radius:10px;font-size:12px;">
    Ajoute au moins 1 vidéo dans les métachamps (custom_video_*) pour afficher les ronds.
  </div>
{%- endif -%}
